import React, { useState } from 'react';

// Main App component
const App = () => {
    // State variables
    const [prompt, setPrompt] = useState(''); // Stores the user's text prompt
    const [images, setImages] = useState([]); // Stores the base64 encoded image URLs
    const [loading, setLoading] = useState(false); // Indicates if images are being generated
    const [errorMessage, setErrorMessage] = useState(''); // Stores any error messages
    const [imageStyle, setImageStyle] = useState('Auto'); // Stores the selected image style
    const [aspectRatio, setAspectRatio] = useState('1:1'); // Stores the selected aspect ratio

    // Function to handle image generation
    const generateImages = async () => {
        setLoading(true); // Set loading to true to show indicator
        setImages([]); // Clear previous images
        setErrorMessage(''); // Clear previous error messages

        try {
            // Check if the prompt is empty
            if (!prompt.trim()) {
                setErrorMessage('Please enter a prompt to generate images.');
                setLoading(false);
                return;
            }

            // Determine width and height based on aspect ratio
            let width, height;
            switch (aspectRatio) {
                case '1:1':
                    width = 1024;
                    height = 1024;
                    break;
                case '16:9':
                    width = 1024;
                    height = 576;
                    break;
                case '9:16':
                    width = 576;
                    height = 1024;
                    break;
                default:
                    width = 1024;
                    height = 1024;
            }

            // Construct the full prompt, including the selected style if not 'Auto'
            const fullPrompt = imageStyle === 'Auto' ? prompt : `${prompt}, ${imageStyle}`;

            // Construct the payload for the image generation API call
            const payload = {
                instances: { prompt: fullPrompt },
                parameters: {
                    sampleCount: 4, // Generate 4 images as requested
                    width: width,
                    height: height,
                }
            };

            // The API key is left as an empty string; Canvas will provide it at runtime for imagen-3.0-generate-002
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            // Make the API call
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Parse the JSON response
            const result = await response.json();

            // Check if images were successfully generated
            if (result.predictions && result.predictions.length > 0) {
                const generatedImageUrls = result.predictions.map(prediction => {
                    // Prepend the base64 prefix to display the image
                    return `data:image/png;base64,${prediction.bytesBase64Encoded}`;
                });
                setImages(generatedImageUrls); // Update the state with generated images
            } else {
                setErrorMessage('No images were generated. Please try a different prompt.');
            }
        } catch (error) {
            console.error('Error generating images:', error);
            setErrorMessage('Failed to generate images. Please try again later.');
        } finally {
            setLoading(false); // Set loading to false once operation is complete
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-purple-800 via-blue-900 to-indigo-950 text-white font-inter flex flex-col items-center justify-center p-4 sm:p-6 lg:p-8">
            <div className="max-w-4xl w-full bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg rounded-2xl shadow-xl p-6 sm:p-8 lg:p-10 border border-purple-400 border-opacity-30">
                <h1 className="text-4xl sm:text-5xl font-extrabold text-center mb-6 sm:mb-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-300 to-pink-300">
                    Dream Weaver AI
                </h1>
                <p className="text-lg text-center mb-8 text-purple-200">
                    Unleash your creativity. Describe your vision, and we'll conjure it into reality.
                </p>

                <div className="mb-8">
                    <textarea
                        className="w-full p-4 text-lg text-gray-800 bg-white bg-opacity-90 rounded-xl border-2 border-purple-500 focus:ring-4 focus:ring-purple-300 focus:border-transparent transition-all duration-300 shadow-inner resize-y min-h-[100px]"
                        placeholder="Enter your vivid description here (e.g., 'A futuristic city at sunset, neon lights reflecting on wet streets, flying cars, cyberpunk style, highly detailed')..."
                        value={prompt}
                        onChange={(e) => setPrompt(e.target.value)}
                        rows="4"
                    ></textarea>
                </div>

                {/* Style Selection Dropdown */}
                <div className="mb-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                    <label htmlFor="imageStyle" className="text-lg text-purple-200">Image Style:</label>
                    <select
                        id="imageStyle"
                        className="p-3 text-lg text-gray-800 bg-white bg-opacity-90 rounded-xl border-2 border-purple-500 focus:ring-4 focus:ring-purple-300 focus:border-transparent transition-all duration-300 shadow-inner"
                        value={imageStyle}
                        onChange={(e) => setImageStyle(e.target.value)}
                    >
                        <option value="Auto">Auto</option>
                        <option value="Realistic">Realistic</option>
                        <option value="Digital Art">Digital Art</option>
                        <option value="Painting">Painting</option>
                        <option value="Anime">Anime</option>
                        <option value="3D Render">3D Render</option>
                        <option value="Minimalist">Minimalist</option>
                    </select>
                </div>

                {/* Aspect Ratio Buttons */}
                <div className="mb-8 flex flex-col items-center">
                    <span className="text-lg text-purple-200 mb-3">Aspect Ratio:</span>
                    <div className="flex gap-4">
                        {['1:1', '16:9', '9:16'].map((ratio) => (
                            <button
                                key={ratio}
                                onClick={() => setAspectRatio(ratio)}
                                className={`px-6 py-2 rounded-lg text-lg font-medium transition-all duration-200
                                    ${aspectRatio === ratio
                                        ? 'bg-purple-600 text-white shadow-md'
                                        : 'bg-white bg-opacity-20 text-purple-100 hover:bg-opacity-30'
                                    }
                                    focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-75`}
                            >
                                {ratio}
                            </button>
                        ))}
                    </div>
                </div>

                <div className="flex justify-center mb-8">
                    <button
                        onClick={generateImages}
                        disabled={loading}
                        className={`px-8 py-3 rounded-full text-xl font-semibold transition-all duration-300 transform
                            ${loading
                                ? 'bg-gray-600 cursor-not-allowed animate-pulse'
                                : 'bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 active:scale-95 shadow-lg hover:shadow-2xl'
                            }
                            focus:outline-none focus:ring-4 focus:ring-purple-300 focus:ring-opacity-75`}
                    >
                        {loading ? (
                            <span className="flex items-center">
                                <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Generating Dreams...
                            </span>
                        ) : (
                            'Generate Images'
                        )}
                    </button>
                </div>

                {errorMessage && (
                    <div className="bg-red-500 text-white p-4 rounded-xl mb-6 text-center shadow-md">
                        {errorMessage}
                    </div>
                )}

                {images.length > 0 && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6 mt-8">
                        {images.map((image, index) => (
                            <div key={index} className="bg-white bg-opacity-15 p-4 rounded-xl shadow-lg border border-purple-400 border-opacity-40 transform hover:scale-105 transition-transform duration-300">
                                <img
                                    src={image}
                                    alt={`Generated Image ${index + 1}`}
                                    className="w-full h-auto rounded-lg object-cover shadow-md"
                                    onError={(e) => {
                                        // Fallback for broken images
                                        e.target.onerror = null;
                                        e.target.src = "https://placehold.co/400x300/6A0DAD/ffffff?text=Image+Failed+to+Load";
                                    }}
                                />
                            </div>
                        ))}
                    </div>
                )}

                {images.length === 0 && !loading && !errorMessage && (
                    <div className="text-center text-purple-300 text-lg mt-8 p-6 bg-white bg-opacity-10 rounded-xl border border-purple-400 border-opacity-30">
                        Your generated images will appear here. Start by typing a prompt above!
                    </div>
                )}

            </div>
            {/* Tailwind CSS Script for compilation */}
            <script src="https://cdn.tailwindcss.com"></script>
            {/* Styles for the font import, embedded using dangerouslySetInnerHTML for React compatibility */}
            <style dangerouslySetInnerHTML={{ __html: `
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
                body {
                    font-family: 'Inter', sans-serif;
                }
            `}} />
        </div>
    );
};
